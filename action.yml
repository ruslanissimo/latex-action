name: 'Compile and publish all LaTeX'
description: 'Checkout, compile LaTeX, compute a version, and deploy on GitHub in one shot.'
inputs:
  token:  # github token
    description: 'Github token for deployment.'
    required: true
  publish-enable:
    description: 'Whether the results should be deployed on GitHub. Defaults to true.'
    required: false
    default: true
  command:
    description: 'The compilation command to use.'
    required: false
    default: 'latexmk -pdf -interaction=nonstopmode'
  verbose:
    description: 'Whether to print out the compiler logs.'
    required: false
    default: 'false'
  success:
    description: 'Name of the variable to output successful compilations.'
    required: false
    default: 'LATEX_SUCCESSES'

runs:
  using: "composite"
  steps:
    - name: Maximize build space
      uses: AdityaGarg8/remove-unwanted-software@v4.1
      with:
        remove-android: 'true'
        remove-cached-tools: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'
        remove-dotnet: 'true'
        remove-haskell: 'true'
        remove-large-packages: 'true'
        remove-swapfile: 'true'
    - name: Make ImageMagik permissive
      shell: bash
      run: sudo sed -i 's/rights=".*"/rights="all"/' /etc/ImageMagick-6/policy.xml
    # Checkout the repository
    - name: Checkout with custom token
      uses: actions/checkout@v6.0.2
      if: inputs.token != ''
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ inputs.token }}
    - name: Checkout with default token
      uses: actions/checkout@v6.0.2
      if: inputs.token == ''
      with:
        fetch-depth: 0
        submodules: recursive
    - name: Fetch tags
      shell: bash
      run: git fetch --tags -f
    - name: Compile all LaTeX files
      id: compile
      shell: bash
      run: |
        docker run --rm \
          --workdir="${GITHUB_WORKSPACE}" \
          -v "${GITHUB_ENV}:${GITHUB_ENV}" \
          -v "${GITHUB_WORKSPACE}:${GITHUB_WORKSPACE}:rw" \
          -v "${GITHUB_OUTPUT}:${GITHUB_OUTPUT}:rw" \
          -e CI \
          -e GITHUB_ENV \
          -e GITHUB_OUTPUT \
          danysk/compile-latex-action:2.2.7 \
          "${{ inputs.command }}" \
          "${{ inputs.verbose }}" \
          "${{ inputs.success }}"
    - name: Deploy
      if: inputs.publish-enable == 'true'
      env:
        GITHUB_TOKEN: ${{ inputs.token }}
      shell: bash
      run: |
        if [[ -z $GITHUB_TOKEN ]]; then
          echo "No token set, cannot deploy"
          false
        else
          if [[ $GITHUB_REF == 'refs/heads/master'
              || $GITHUB_REF == 'refs/heads/main'
              || $GITHUB_REF == 'refs/heads/default'
              || $GITHUB_REF == "refs/tags"*
          ]]; then
            # Use 'latest'
            TAG=$(git describe --tags --exact-match HEAD 2>/dev/null || echo "latest")
            echo "Preparing release $TAG"
            
            # Remove old teg localy
            git tag --delete "$TAG" 2>/dev/null || true
            git tag "$TAG"
            
            # Push the tag
            git push origin "$TAG" --force && echo "Tag $TAG successfully pushed" || true
            
            # Update release
            gh release create "$TAG" --title "Release $TAG" --notes "Automated PDF build" || echo "Release already exists"
            
            while IFS= read -r file; do
              pdf="${file%.*}.pdf"
              echo "Delivering file $pdf"
              gh release upload "$TAG" "$pdf" --clobber
            done <<< "$LATEX_SUCCESSES"
          else
            echo "Not running deployment from unknown source: $GITHUB_REF"
          fi
        fi
    
